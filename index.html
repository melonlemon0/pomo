<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë½€ëª¨ ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ğŸ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top, #fff4e6, #ffeef7);
    }

    .app {
      width: 100%;
      max-width: 820px;
      margin: 24px 12px;
      background: #ffffffcc;
      border-radius: 20px;
      padding: 20px 18px 18px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
      backdrop-filter: blur(12px);
      border: 1px solid #ffd6e0;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.7rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 14px;
    }

    .hidden {
      display: none;
    }

    .screen {
      margin-top: 8px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* ì´ë¦„ ì„ íƒ í™”ë©´ */
    #nameSearch {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e3d7ff;
      font-size: 0.9rem;
      outline: none;
      margin-bottom: 10px;
      background: #faf7ff;
    }

    #nameSearch:focus {
      border-color: #ff9ecb;
      box-shadow: 0 0 0 3px rgba(255, 158, 203, 0.25);
      background: #fff;
    }

    .name-list {
      max-height: 360px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 6px;
    }

    .name-btn {
      border-radius: 999px;
      border: 1px solid #f0e4ff;
      padding: 6px 10px;
      font-size: 0.85rem;
      text-align: left;
      background: #ffffff;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s,
        border-color 0.15s;
    }

    .name-btn:hover {
      background: #fff4f9;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.07);
      transform: translateY(-1px);
    }

    .name-btn.selected {
      background: #ffe1f1;
      border-color: #ff9ecb;
      box-shadow: 0 0 0 2px rgba(255, 158, 203, 0.35);
    }

    .name-footer {
      margin-top: 10px;
      text-align: right;
      font-size: 0.8rem;
      color: #888;
    }

    .primary-btn,
    .secondary-btn {
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 600;
      transition: transform 0.08s, box-shadow 0.08s, opacity 0.08s;
    }

    .primary-btn {
      background: linear-gradient(135deg, #ff9ecb, #ffd884);
      color: #4b2530;
      box-shadow: 0 8px 16px rgba(255, 140, 184, 0.5);
    }

    .secondary-btn {
      background: #f4ecff;
      color: #5a4a7a;
      box-shadow: 0 4px 10px rgba(90, 74, 122, 0.15);
    }

    .primary-btn:hover,
    .secondary-btn:hover {
      transform: translateY(-1px);
    }

    .primary-btn:active,
    .secondary-btn:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    /* íƒ€ì´ë¨¸ í™”ë©´ */
    .timer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .current-name {
      font-size: 0.9rem;
      color: #444;
    }

    .phase-label {
      font-size: 0.9rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e5f6ff;
      color: #15536b;
    }

    .phase-label.study {
      background: #e2f1ff;
      color: #21527a;
    }

    .phase-label.break {
      background: #ffe5f0;
      color: #8c2649;
    }

    .timer-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 10px 0 14px;
    }

    .timer-circle {
      width: min(260px, 70vw);
      height: min(260px, 70vw);
      border-radius: 50%;
      border: 4px solid #ffcfe0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #fffaf4, #ffeaf5);
      box-shadow: 0 12px 30px rgba(255, 140, 184, 0.6);
      position: relative;
      overflow: hidden;
      transition: background 0.3s ease, border-color 0.3s ease,
        box-shadow 0.3s ease;
    }

    .timer-circle.study {
      border-color: #bfdcff;
      background: radial-gradient(circle at top, #f4f9ff, #d6ecff);
      box-shadow: 0 12px 30px rgba(140, 190, 255, 0.6);
    }

    .timer-circle.break {
      border-color: #ffcfe0;
      background: radial-gradient(circle at top, #fff5fa, #ffd6e8);
      box-shadow: 0 12px 30px rgba(255, 140, 184, 0.6);
    }

    .timer-text {
      font-size: 3rem;
      font-weight: 700;
      color: #333;
      position: relative;
      z-index: 2;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* ë– ë‹¤ë‹ˆëŠ” ì´ëª¨ì§€ */
    .emoji-layer {
      position: absolute;
      inset: 8%;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .emoji-bubble {
      position: absolute;
      opacity: 0.7;
      animation: floatEmoji 10s ease-in-out infinite alternate;
    }

    @keyframes floatEmoji {
      0% {
        transform: translate(var(--x-start), var(--y-start));
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translate(var(--x-end), var(--y-end));
        opacity: 0.6;
      }
    }

    .timer-sub {
      font-size: 0.9rem;
      color: #777;
      margin-top: 4px;
      text-align: center;
    }

    .timer-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .extra-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .status-line {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #777;
      min-height: 18px;
      text-align: center;
    }

    .session-tasks {
      margin-top: 12px;
      padding: 10px 10px 8px;
      border-radius: 14px;
      background: #fff9fb;
      border: 1px solid #ffd6e8;
    }

    .session-tasks-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .my-task-card {
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #ffe7f3;
      border: 1px solid #ffb6da;
      font-size: 0.9rem;
    }

    .my-task-header {
      font-size: 0.82rem;
      font-weight: 600;
      color: #a11a54;
      margin-bottom: 4px;
    }

    .my-task-text {
      font-size: 0.95rem;
      font-weight: 600;
      color: #4a2b3a;
    }

    .other-tasks-list {
      font-size: 0.82rem;
      color: #555;
    }

    .other-task-item {
      margin-bottom: 2px;
    }

    .other-name {
      font-weight: 600;
      margin-right: 4px;
    }

    .no-session-tasks {
      font-size: 0.8rem;
      color: #999;
    }

    .active-names-section {
      margin-top: 14px;
    }

    .active-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .active-names {
      min-height: 40px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .active-chip {
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.85rem;
      background: #fff4fa;
      border: 1px solid #ffd6e8;
    }

    .active-chip.me {
      background: #ffe4f2;
      border-color: #ff9ecb;
      font-weight: 600;
    }

    .hint-line {
      font-size: 0.78rem;
      color: #999;
      margin-top: 6px;
    }

    .sticker-table {
      margin-top: 14px;
      font-size: 0.85rem;
    }

    .sticker-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .sticker-table th,
    .sticker-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #f0e4ff;
      text-align: left;
    }

    .sticker-table th {
      background: #faf7ff;
      font-weight: 600;
      color: #555;
    }

    .sticker-table .time-col {
      white-space: nowrap;
      width: 80px;
    }

    .no-stickers {
      font-size: 0.85rem;
      color: #aaa;
      text-align: left;
    }

    .date-label {
      font-size: 0.82rem;
      font-weight: 600;
      margin: 8px 0 4px;
      color: #555;
    }

    /* í•  ì¼ ë³´ë“œ í™”ë©´ */
    .board-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .board-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .board-sub {
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 8px;
    }

    .board-wrapper {
      border-radius: 14px;
      border: 1px solid #e3d7ff;
      background: #faf7ff;
      padding: 8px;
    }

    .board-scroll {
      overflow-x: auto;
    }

    #taskBoardTable {
      border-collapse: collapse;
      min-width: 720px;
      font-size: 0.8rem;
    }

    #taskBoardTable th,
    #taskBoardTable td {
      border: 1px solid #e3d7ff;
      padding: 4px;
      text-align: left;
      min-width: 80px;
    }

    #taskBoardTable thead th {
      background: #f4ecff;
      font-weight: 600;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    #taskBoardTable .member-col {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #fefbff;
      min-width: 120px;
      max-width: 140px;
      white-space: nowrap;
    }

    .board-task-input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #e3d7ff;
      padding: 3px 4px;
      font-size: 0.8rem;
      background: #ffffff;
      outline: none;
    }

    .board-task-input:focus {
      border-color: #ff9ecb;
      box-shadow: 0 0 0 2px rgba(255, 158, 203, 0.25);
    }

    .board-task-cell {
      position: relative;
      background: #ffffff;
    }

    .board-task-cell.me {
      background: #fff6fb;
    }

    .board-task-emoji {
      position: absolute;
      right: 2px;
      bottom: 1px;
      font-size: 0.9rem;
    }

    .board-task-text-readonly {
      font-size: 0.78rem;
      color: #555;
      padding-right: 18px;
      min-height: 1.2em;
    }

    .board-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: #777;
    }

    /* ëŒ€í™”ë°© */
    .chat-wrapper {
      border-radius: 14px;
      border: 1px solid #ffd6e8;
      background: #fff9fb;
      padding: 8px;
      display: flex;
      flex-direction: column;
      height: 420px;
      max-height: calc(100vh - 210px);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 4px;
    }

    .chat-message {
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #ffe1f1;
      font-size: 0.83rem;
      max-width: 90%;
    }

    .chat-message.me {
      margin-left: auto;
      background: #ffe7f3;
      border-color: #ffb6da;
    }

    .chat-meta {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .chat-text {
      white-space: pre-wrap;
      word-break: break-word;
      color: #333;
    }

    .chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    #chatInput {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #ffd6e8;
      padding: 7px 10px;
      font-size: 0.85rem;
      outline: none;
      background: #ffffff;
    }

    #chatInput:focus {
      border-color: #ff9ecb;
      box-shadow: 0 0 0 2px rgba(255, 158, 203, 0.25);
    }

    #sendChatBtn {
      padding-inline: 12px;
      font-size: 0.85rem;
    }

    @media (max-width: 600px) {
      .app {
        margin: 16px 8px;
        padding: 16px 12px 14px;
      }
      .timer-text {
        font-size: 2.4rem;
      }
      .name-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ë½€ëª¨ ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ ğŸ…</h1>
    <div class="subtitle">
      ì´ë¦„ ì„ íƒ â†’ íƒ€ì´ë¨¸ â†’ í•  ì¼ ë³´ë“œ &amp; ëŒ€í™”ë°©ìœ¼ë¡œ ê°™ì´ ê³µë¶€í•´ìš” ğŸ’¬
    </div>

    <!-- 1. ì´ë¦„ ì„ íƒ í™”ë©´ -->
    <div id="name-screen" class="screen">
      <div class="section-title">1. ì´ë¦„ ì„ íƒí•˜ê¸°</div>
      <input
        id="nameSearch"
        type="text"
        placeholder="ì´ë¦„ ë˜ëŠ” ì´ëª¨ì§€ ê²€ìƒ‰..."
      />
      <div id="nameList" class="name-list"></div>
      <div class="name-footer">
        ì´ë¦„ ì„ íƒ í›„ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ íƒ€ì´ë¨¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
      </div>
      <div style="margin-top: 10px; text-align: center;">
        <button id="goTimerBtn" class="primary-btn">â± íƒ€ì´ë¨¸ë¡œ ê°€ê¸°</button>
      </div>
    </div>

    <!-- 2. íƒ€ì´ë¨¸ í™”ë©´ -->
    <div id="timer-screen" class="screen hidden">
      <div class="timer-header">
        <div class="current-name">
          í˜„ì¬ ì ‘ì†: <span id="currentName"></span>
        </div>
        <div class="phase-label" id="phaseLabel">ê³„ì‚° ì¤‘...</div>
        <button id="changeNameBtn" class="secondary-btn">ğŸ”„ ì´ë¦„ ë³€ê²½</button>
      </div>

      <div class="timer-wrapper">
        <div class="timer-circle" id="timerCircle">
          <div class="emoji-layer" id="emojiLayer"></div>
          <div class="timer-text" id="timerDisplay">--:--</div>
        </div>
        <div class="timer-sub" id="timerSubText">
          ì •ê°/30ë¶„ ê¸°ì¤€ìœ¼ë¡œ ìë™ìœ¼ë¡œ ë§ì¶°ì§‘ë‹ˆë‹¤.
        </div>

        <div class="timer-controls">
          <button id="startBtn" class="primary-btn">
            â–¶ï¸ ì‹œì‘í•˜ê¸° (ê³µë¶€ ì¤‘ í‘œì‹œ)
          </button>
          <button id="stopBtn" class="secondary-btn">
            â¹ ëë‚´ê¸° (ê³µë¶€ ì¢…ë£Œ)
          </button>
        </div>

        <div class="extra-controls">
          <button id="openBoardBtn" class="secondary-btn">
            ğŸ§¾ ì˜¤ëŠ˜ì˜ í•  ì¼ ë³´ë“œ
          </button>
          <button id="openChatBtn" class="secondary-btn">ğŸ’¬ ëŒ€í™”ë°©</button>
          <button id="showStickersBtn" class="secondary-btn">
            ğŸ“Š ìŠ¤í‹°ì»¤ ê¸°ë¡
          </button>
        </div>

        <div class="status-line" id="statusLine"></div>
      </div>

      <!-- ì´ë²ˆ ì„¸ì…˜ í•  ì¼ -->
      <div class="session-tasks" id="sessionTasks"></div>

      <!-- í˜„ì¬ ê³µë¶€ ì¤‘ ë©¤ë²„ -->
      <div class="active-names-section">
        <div class="active-title">ì§€ê¸ˆ ê°™ì´ ê³µë¶€ ì¤‘ì¸ ë½€ëª¨ ë©¤ë²„ ğŸ…</div>
        <div id="activeNames" class="active-names"></div>
        <div class="hint-line">
          â€» â€œì‹œì‘í•˜ê¸°â€ë¥¼ ëˆ„ë¥´ë©´ ì´ë¦„ì´ ì˜¬ë¼ê°€ê³ ,<br />
          â€œëë‚´ê¸°â€ë¥¼ ëˆŒëŸ¬ì•¼ <strong>ìŠ¤í‹°ì»¤ ì¡°ê±´</strong>ì´ ì²´í¬ë©ë‹ˆë‹¤.<br />
          (ìŠ¤í‹°ì»¤: ì„¸ì…˜ ì‹œì‘ ì „/í›„ 5ë¶„ + ì¢…ë£Œ í›„ 5ë¶„ ì´ë‚´)
        </div>
      </div>

      <!-- ìŠ¤í‹°ì»¤ ê¸°ë¡ -->
      <div class="sticker-table" id="stickerTable"></div>
    </div>

    <!-- 3. í•  ì¼ ë³´ë“œ í™”ë©´ -->
    <div id="board-screen" class="screen hidden">
      <div class="board-header">
        <div class="board-title">ì˜¤ëŠ˜ì˜ í•  ì¼ ë³´ë“œ ğŸ§¾</div>
        <button id="backToTimerBtn" class="secondary-btn">
          â± íƒ€ì´ë¨¸ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
      <div class="board-sub">
        ì„¸ë¡œ: ì˜¤ëŠ˜ í•  ì¼ì„ í•œ ë²ˆì´ë¼ë„ ì ì€ ë½€ëª¨ ë©¤ë²„ + ë‚˜ (ë‚´ ì´ë¦„ì´ í•­ìƒ
        ë§¨ ìœ„)<br />
        ê°€ë¡œ: ì•„ì¹¨ 6ì‹œ ~ ë°¤ 12ì‹œê¹Œì§€ 30ë¶„ ë‹¨ìœ„ ì„¸ì…˜.<br />
        ë‚´ ì¤„ë§Œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•˜ê³ , ìŠ¤í‹°ì»¤ë¥¼ ì–»ì€ ì„¸ì…˜ì—ëŠ” ì´ëª¨ì§€ê°€
        í‘œì‹œë©ë‹ˆë‹¤.
      </div>
      <div class="board-wrapper">
        <div class="board-scroll">
          <table id="taskBoardTable"></table>
        </div>
        <div class="board-footer">
          <span>â€» ì¹¸ ë¹„ìš°ê³  ì €ì¥í•˜ë©´ í•´ë‹¹ ì„¸ì…˜ í•  ì¼ì´ ì‚­ì œë©ë‹ˆë‹¤.</span>
          <button
            id="saveBoardBtn"
            class="primary-btn"
            style="padding: 7px 12px; font-size: 0.85rem;"
          >
            ğŸ’¾ ë‚´ í•  ì¼ ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- 4. ëŒ€í™”ë°© í™”ë©´ -->
    <div id="chat-screen" class="screen hidden">
      <div class="board-header">
        <div class="board-title">ë½€ëª¨ ëŒ€í™”ë°© ğŸ’¬</div>
        <button id="backFromChatBtn" class="secondary-btn">
          â± íƒ€ì´ë¨¸ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
      <div class="board-sub">
        ê³µë¶€ ì „/í›„ í•œë§ˆë””, ì‘ì›, ì¡ë‹´ ë“± ììœ ë¡­ê²Œ ì±„íŒ…í•´ ì£¼ì„¸ìš”.<br />
        (ë‹‰ë„¤ì„ì€ ìœ„ì—ì„œ ì„ íƒí•œ ë½€ëª¨ ì´ë¦„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤)
      </div>
      <div class="chat-wrapper">
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-row">
          <input
            id="chatInput"
            type="text"
            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enter ë˜ëŠ” ì „ì†¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ìš” âœ¨"
          />
          <button id="sendChatBtn" class="primary-btn">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    // Supabase ì´ˆê¸°í™” (CDN ì „ì—­ ê°ì²´ ì‚¬ìš©)
    var SUPABASE_URL = "https://upiobealvympxbypfmkc.supabase.co";
    var SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaW9iZWFsdnltcHhieXBmbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzYxNDIsImV4cCI6MjA3ODk1MjE0Mn0.mLvGyy-eMWr-ow2b2USMg7PXKq2EUfK1fyJEsdGThKw";

    // CDNì—ì„œ ì œê³µí•˜ëŠ” ì „ì—­ supabase ê°ì²´
    var createClient = window.supabase.createClient;
    var supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    var MEMBERS = [
      "ë°•ë¯¸ì„ ğŸ§¶",
      "ê³ ì£¼ì—°ğŸ¬",
      "ë¬¸í•˜ì˜ğŸŒ™",
      "ì „ì€ì„ğŸ•",
      "ì´ì•„ë¡œğŸ°",
      "ê¹€íƒœí›ˆğŸªµ",
      "ë°•ì •í˜„ğŸ¥",
      "ìœ¤ì¥í˜ğŸ¦‡",
      "ê¹€ë¯¼ì§€ğŸšˆ",
      "ì´ì •ì² ğŸŒµ",
      "ê¶Œë„ì´ğŸŸ",
      "ì„ê°€ì˜ğŸ”®",
      "ì •ì„±ìš°ğŸ¥°",
      "ê¹€ì˜ì„œğŸ¾",
      "ìµœë¬¸ì˜ğŸ",
      "ì´ê²½í‘œğŸ«",
      "ê¹€ì„±í™˜ğŸ˜",
      "ì„±ê·œí˜„â™¾ï¸",
      "ë°•ì€ì§€ğŸ¦š",
      "ë°•ì¢…í˜ğŸ·",
      "ê¹€ì •í˜„ğŸ»",
      "ì†¡ì°½í˜¸ğŸª–",
      "ë°•ë¯¼ì„ğŸ›ï¸",
      "ì´ì˜ˆì›ğŸ­",
      "ì¡°ì¬í˜„ğŸ",
      "ì¡°ì„œì˜ğŸ‡¬ğŸ‡§",
      "ê³ ë³‘ì°¬âš½ï¸",
      "ì •ë¯¼ì˜ğŸ¦¦",
      "ì¡°ì„±í˜„ğŸµ",
      "ì´ì§€ì€ğŸ’",
      "í™©ìƒˆë²½ğŸŒ†",
      "ì¡°ì •ë²”ğŸ«’",
      "ë°•ì˜í›ˆğŸ‘»",
      "ê°•ë¯¼ì •ğŸŒ½",
      "ë°•ì¬ì§„ğŸŒŠ",
      "ì´ìŠ¹í˜¸ğŸ²",
      "ê¹€ë¯¼ì •ğŸ¨",
      "ì „í•˜ìœ¤ğŸ§€",
      "ì´ë‚¨ìˆ˜ğŸ‘‡",
      "ê¹€ì€ì„±ğŸ±",
      "ê¹€ì§€í™˜ğŸ”®",
      "ì´ì¬ì›ğŸ’µ",
      "ì •ì—°ìˆ˜ğŸ¦­",
      "ê¹€ë„í›ˆğŸ–ï¸",
      "ì´ê¸ˆë¹„ğŸŒ§",
      "ìµœì§€ì›ğŸ•³",
      "ë°•ë¯¼ê²½ğŸ‰",
      "ê¶Œê·œë²”ğŸ†",
      "ë°•ëŒ€í—ŒğŸ¥‹",
      "ì •ë‹¤í¬ğŸ¿ï¸",
      "ê¹€ì°½í›ˆğŸªŸ",
      "ì¡°ì¶©ì—°ğŸ¦â€ğŸ”¥",
      "ìµœë‹¤ì˜ˆğŸ­",
      "ìµœì„œì˜ğŸ‘",
      "ë…¸ì†Œí˜„ğŸ¢",
      "ë°•ìš°ë¹ˆâ˜”ï¸",
      "ì´ê°€í˜„ğŸ¥",
      "ë°°ì§€ì€ğŸ’",
      "ì •ê³„í›ˆğŸ¥š",
      "ì¸ì¹˜ê´‘ğŸ’¡",
      "ê°•íƒœí›ˆğŸ’ª",
      "ë°•ê²½ì„œğŸŒ…",
      "ë°•ì¤€í‘œğŸ•",
      "ì¡°ì›ì°½ğŸ›¡ï¸",
      "ì§€ìŠ¬ì•„ğŸ§Š",
      "ì°¨ë¯¼êµ¬â™ ï¸",
      "ì–‘ì§„í¬ğŸ‘",
      "ë°•í˜œì—°ğŸŠ",
      "ì„œì›ë‘â˜•ï¸",
      "ì•ˆë³´í˜„ğŸ˜",
      "ìš°ì€ì§€ğŸ’",
      "ê¹€ë¯¼ì„­ğŸ•¶ï¸",
      "ë°•ë¯¸ì„ ğŸ³",
      "ì—¬ì§€ì›ğŸ•¹ï¸",
      "ìœ í˜„ë¹ˆâ˜€ï¸",
      "ì´í˜„ì¤€ğŸ«",
      "ì´í˜„ì§€ğŸ’Œ",
      "í—ˆíƒœì›…ğŸ€",
      "ë¥˜ê²½í˜¸ğŸ‘®",
      "ë°•ë™ê±´â˜„ï¸",
      "ê³ í¬ì›ğŸ˜„",
      "ê¹€ê¸°ì›âšª",
      "ê¹€ì˜ˆì›ğŸ¥",
      "ê¹€ì¤€í˜•ğŸ¤–",
      "ê¹€ì§„ê³¤ğŸ™",
      "ê¹€ì§„ìˆ˜ğŸ’¦",
      "ê¹€íƒœê²½ğŸŒ±",
      "ë¯¼ì§€í˜„ğŸ",
      "ë°±í•˜ìœ¤â„ï¸",
      "ì†¡ì˜í›ˆğŸ’¿",
      "ì–‘ì†Œì—°ğŸŸ",
      "ìœ¤ì‹ í˜œğŸ˜†",
      "ìœ¤ì£¼ì„±ğŸ°",
      "ì´ì¤€í˜¸ğŸ‘£",
      "ì´ì°½í˜„ğŸŒ",
      "ì •ë³‘í˜ğŸ¸",
      "ì •ì˜ˆì€ğŸ§‡",
      "ì •ìœ ë¯¼ğŸ¹",
      "ì¡°ë¯¼ì œğŸ¦",
      "ìµœì˜ì¸ğŸ“€",
      "í•˜ìœ ì²­ğŸ¶",
      "í™ìŠ¹í˜„ğŸ³"
    ];

    var nameScreen = document.getElementById("name-screen");
    var timerScreen = document.getElementById("timer-screen");
    var boardScreen = document.getElementById("board-screen");
    var chatScreen = document.getElementById("chat-screen");

    var nameListEl = document.getElementById("nameList");
    var nameSearchEl = document.getElementById("nameSearch");
    var goTimerBtn = document.getElementById("goTimerBtn");
    var currentNameEl = document.getElementById("currentName");
    var changeNameBtn = document.getElementById("changeNameBtn");
    var timerDisplay = document.getElementById("timerDisplay");
    var timerSubText = document.getElementById("timerSubText");
    var phaseLabel = document.getElementById("phaseLabel");
    var timerCircle = document.getElementById("timerCircle");
    var emojiLayerEl = document.getElementById("emojiLayer");
    var startBtn = document.getElementById("startBtn");
    var stopBtn = document.getElementById("stopBtn");
    var statusLine = document.getElementById("statusLine");
    var activeNamesEl = document.getElementById("activeNames");
    var sessionTasksEl = document.getElementById("sessionTasks");
    var showStickersBtn = document.getElementById("showStickersBtn");
    var stickerTableEl = document.getElementById("stickerTable");
    var openBoardBtn = document.getElementById("openBoardBtn");
    var backToTimerBtn = document.getElementById("backToTimerBtn");
    var taskBoardTable = document.getElementById("taskBoardTable");
    var saveBoardBtn = document.getElementById("saveBoardBtn");
    var openChatBtn = document.getElementById("openChatBtn");
    var backFromChatBtn = document.getElementById("backFromChatBtn");
    var chatMessagesEl = document.getElementById("chatMessages");
    var chatInputEl = document.getElementById("chatInput");
    var sendChatBtn = document.getElementById("sendChatBtn");

    var selectedName = null;
    var selectedButton = null;
    var lastTaskBlockKey = null;

    var boardSlots = [];
    var boardMembers = [];
    var boardEditableInputs = [];

    var chatMessagesCache = [];

    /* ---- ê³µí†µ ìœ í‹¸ ---- */
    function getLocalDateStr(d) {
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    /* ---- ë¸”ë¡ ê³„ì‚° ---- */
    function getCurrentBlock(now) {
      if (!now) now = new Date();
      var m = now.getMinutes();
      var s = now.getSeconds();
      var totalSec = m * 60 + s;

      var blockStart = new Date(now.getTime());
      blockStart.setSeconds(0, 0);
      if (totalSec < 30 * 60) blockStart.setMinutes(0);
      else blockStart.setMinutes(30);

      var blockEnd = new Date(blockStart.getTime() + 25 * 60 * 1000);
      var joinDeadline = new Date(blockStart.getTime() + 5 * 60 * 1000);
      var endDeadline = new Date(blockEnd.getTime() + 5 * 60 * 1000);
      var phase = now < blockEnd ? "study" : "break";
      var blockKey = blockStart.toISOString();
      var blockDateStr = getLocalDateStr(blockStart);

      return {
        phase: phase,
        blockStart: blockStart,
        blockEnd: blockEnd,
        joinDeadline: joinDeadline,
        endDeadline: endDeadline,
        blockKey: blockKey,
        blockDateStr: blockDateStr
      };
    }

    function getSessionWindowForJoin(joinedAtInput) {
      var d = new Date(joinedAtInput);
      var sessionStart = new Date(d.getTime());
      sessionStart.setSeconds(0, 0);

      var m = d.getMinutes();
      var s = d.getSeconds();
      var totalSec = m * 60 + s;

      if (totalSec < 30 * 60) {
        if (totalSec < 25 * 60) {
          sessionStart.setMinutes(0);
        } else {
          sessionStart.setMinutes(30);
        }
      } else {
        if (totalSec < 55 * 60) {
          sessionStart.setMinutes(30);
        } else {
          sessionStart.setHours(sessionStart.getHours() + 1);
          sessionStart.setMinutes(0);
        }
      }

      var validUntil = new Date(sessionStart.getTime() + 30 * 60 * 1000);
      return { sessionStart: sessionStart, validUntil: validUntil };
    }

    function formatTimeLabel(d) {
      return d.toLocaleTimeString("ko-KR", {
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    /* ---- íƒ€ì´ë¨¸ ---- */
    function updateTimer() {
      var now = new Date();
      var m = now.getMinutes();
      var s = now.getSeconds();
      var totalSec = m * 60 + s;

      var info = getCurrentBlock(now);
      var nextBoundary;
      var phase;

      if (totalSec < 25 * 60) {
        phase = "study";
        nextBoundary = 25 * 60;
      } else if (totalSec < 30 * 60) {
        phase = "break";
        nextBoundary = 30 * 60;
      } else if (totalSec < 55 * 60) {
        phase = "study";
        nextBoundary = 55 * 60;
      } else {
        phase = "break";
        nextBoundary = 60 * 60;
      }

      var remaining = nextBoundary - totalSec;
      if (remaining < 0) remaining = 0;
      var mm = Math.floor(remaining / 60);
      var ss = remaining % 60;

      timerDisplay.textContent =
        String(mm).padStart(2, "0") + ":" + String(ss).padStart(2, "0");

      if (phase === "study") {
        phaseLabel.textContent = "ê³µë¶€ ì‹œê°„ ğŸ… (25ë¶„)";
        phaseLabel.classList.add("study");
        phaseLabel.classList.remove("break");
        timerSubText.textContent = "ì •ê°/30ë¶„ ê¸°ì¤€ 25ë¶„ ê³µë¶€ ì¤‘ì…ë‹ˆë‹¤.";
        timerCircle.classList.add("study");
        timerCircle.classList.remove("break");
      } else {
        phaseLabel.textContent = "ì‰¬ëŠ” ì‹œê°„ â˜• (5ë¶„)";
        phaseLabel.classList.add("break");
        phaseLabel.classList.remove("study");
        timerSubText.textContent = "5ë¶„ íœ´ì‹ íƒ€ì„! ë¬¼ ë§ˆì‹œê³  ìŠ¤íŠ¸ë ˆì¹­ ğŸŒ¿";
        timerCircle.classList.add("break");
        timerCircle.classList.remove("study");
      }

      if (info.blockKey !== lastTaskBlockKey) {
        lastTaskBlockKey = info.blockKey;
        loadCurrentSessionTasks(info);
      }
    }

    setInterval(updateTimer, 1000);
    updateTimer();

    /* ---- ì´ë¦„ ì„ íƒ ---- */
    function renderNameButtons(filter) {
      if (filter === undefined || filter === null) filter = "";
      nameListEl.innerHTML = "";
      var lower = filter.trim().toLowerCase();

      MEMBERS.forEach(function (name) {
        if (lower && name.toLowerCase().indexOf(lower) === -1) return;

        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "name-btn";
        btn.textContent = name;

        if (selectedName === name) {
          btn.classList.add("selected");
          selectedButton = btn;
        }

        btn.addEventListener("click", function () {
          selectedName = name;
          localStorage.setItem("pomodoroName", selectedName);

          if (selectedButton) selectedButton.classList.remove("selected");
          btn.classList.add("selected");
          selectedButton = btn;
        });

        nameListEl.appendChild(btn);
      });

      if (!nameListEl.innerHTML) {
        nameListEl.innerHTML =
          '<div style="font-size:0.85rem;color:#999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }

    nameSearchEl.addEventListener("input", function (e) {
      renderNameButtons(e.target.value);
    });

    function showNameScreen() {
      nameScreen.classList.remove("hidden");
      timerScreen.classList.add("hidden");
      boardScreen.classList.add("hidden");
      chatScreen.classList.add("hidden");
      statusLine.textContent = "";
    }

    function showTimerScreen() {
      if (!selectedName) {
        alert("ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        return;
      }
      currentNameEl.textContent = selectedName;
      nameScreen.classList.add("hidden");
      timerScreen.classList.remove("hidden");
      boardScreen.classList.add("hidden");
      chatScreen.classList.add("hidden");
      statusLine.textContent = "";

      loadActiveMembers();
      var info = getCurrentBlock();
      loadCurrentSessionTasks(info);
    }

    goTimerBtn.addEventListener("click", showTimerScreen);

    changeNameBtn.addEventListener("click", function () {
      leaveSession();
      showNameScreen();
    });

    /* ---- active ë©¤ë²„ + ì´ëª¨ì§€ ---- */
    async function loadActiveMembers() {
      var result = await supabase
        .from("pomodoro_active")
        .select("*")
        .order("joined_at", { ascending: true });

      var data = result.data;
      var error = result.error;

      if (error) {
        console.error("loadActiveMembers error", error);
        statusLine.textContent = "ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
        return;
      }

      var now = new Date();
      var filtered = (data || []).filter(function (row) {
        if (!row.joined_at) return true;
        var windowInfo = getSessionWindowForJoin(row.joined_at);
        return now <= windowInfo.validUntil;
      });

      renderActiveMembers(filtered);
    }

    function renderActiveMembers(rows) {
      activeNamesEl.innerHTML = "";

      if (!rows.length) {
        activeNamesEl.innerHTML =
          '<span style="font-size:0.85rem;color:#aaa;">ì•„ì§ ì•„ë¬´ë„ ê³µë¶€ë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ì–´ìš”.</span>';
        renderEmojiLayer([]);
        return;
      }

      rows.forEach(function (row) {
        var chip = document.createElement("div");
        chip.className = "active-chip";
        if (row.member_name === selectedName) chip.classList.add("me");
        chip.textContent = row.member_name;
        activeNamesEl.appendChild(chip);
      });

      renderEmojiLayer(rows);
    }

    function renderEmojiLayer(rows) {
      emojiLayerEl.innerHTML = "";
      var maxEmojis = Math.min(rows.length, 10);

      for (var i = 0; i < maxEmojis; i++) {
        var row = rows[i];
        var glyphs = Array.from(row.member_name);
        var emoji = glyphs[glyphs.length - 1] || "ğŸ…";

        var span = document.createElement("span");
        span.className = "emoji-bubble";
        span.textContent = emoji;

        var xStart = (Math.random() * 120 - 60).toFixed(0) + "px";
        var yStart = (Math.random() * 120 - 60).toFixed(0) + "px";
        var xEnd = (Math.random() * 120 - 60).toFixed(0) + "px";
        var yEnd = (Math.random() * 120 - 60).toFixed(0) + "px";

        span.style.setProperty("--x-start", xStart);
        span.style.setProperty("--y-start", yStart);
        span.style.setProperty("--x-end", xEnd);
        span.style.setProperty("--y-end", yEnd);
        span.style.left = "50%";
        span.style.top = "50%";
        span.style.fontSize = (Math.random() * 16 + 28).toFixed(0) + "px";
        span.style.animationDelay = (Math.random() * 4).toFixed(2) + "s";

        emojiLayerEl.appendChild(span);
      }
    }

    /* ---- ì´ë²ˆ ì„¸ì…˜ í•  ì¼ ---- */
    async function loadCurrentSessionTasks(info) {
      var result = await supabase
        .from("pomodoro_tasks")
        .select("*")
        .eq("block_key", info.blockKey);

      var data = result.data;
      var error = result.error;

      if (error) {
        console.error("loadCurrentSessionTasks error", error);
        sessionTasksEl.innerHTML =
          '<div class="no-session-tasks">ì´ë²ˆ ì„¸ì…˜ í•  ì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢</div>';
        return;
      }
      renderSessionTasks(data || [], info);
    }

    function renderSessionTasks(rows, info) {
      sessionTasksEl.innerHTML = "";

      var timeLabel = formatTimeLabel(info.blockStart);
      var titleDiv = document.createElement("div");
      titleDiv.className = "session-tasks-title";
      titleDiv.textContent = "ì´ë²ˆ ì„¸ì…˜ (" + timeLabel + ") í•  ì¼ ë³´ê¸°";
      sessionTasksEl.appendChild(titleDiv);

      if (!rows.length) {
        var empty = document.createElement("div");
        empty.className = "no-session-tasks";
        empty.textContent = "ì•„ì§ ì´ë²ˆ ì„¸ì…˜ì— ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
        sessionTasksEl.appendChild(empty);
        return;
      }

      var myRow = rows.find(function (r) {
        return r.member_name === selectedName;
      });
      var others = rows.filter(function (r) {
        return r.member_name !== selectedName;
      });

      if (myRow) {
        var myCard = document.createElement("div");
        myCard.className = "my-task-card";

        var h = document.createElement("div");
        h.className = "my-task-header";
        h.textContent = "ë‚´ í•  ì¼ (" + myRow.member_name + ")";

        var txt = document.createElement("div");
        txt.className = "my-task-text";
        txt.textContent = myRow.task_text;

        myCard.appendChild(h);
        myCard.appendChild(txt);
        sessionTasksEl.appendChild(myCard);
      }

      if (others.length) {
        var listDiv = document.createElement("div");
        listDiv.className = "other-tasks-list";

        others.forEach(function (r) {
          var item = document.createElement("div");
          item.className = "other-task-item";

          var nameSpan = document.createElement("span");
          nameSpan.className = "other-name";
          nameSpan.textContent = r.member_name;

          var textSpan = document.createElement("span");
          textSpan.textContent = r.task_text;

          item.appendChild(nameSpan);
          item.appendChild(textSpan);
          listDiv.appendChild(item);
        });

        sessionTasksEl.appendChild(listDiv);
      }
    }

    /* ---- ì„¸ì…˜ ì°¸ì—¬/ì¢…ë£Œ + ìŠ¤í‹°ì»¤ ---- */
    async function joinSession() {
      if (!selectedName) {
        alert("ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        return;
      }
      statusLine.textContent = "ê³µë¶€ ì‹œì‘ í‘œì‹œ ì¤‘...";

      // ê¸°ì¡´ active ì‚­ì œ
      await supabase
        .from("pomodoro_active")
        .delete()
        .eq("member_name", selectedName);

      var result = await supabase
        .from("pomodoro_active")
        .insert({ member_name: selectedName });

      if (result.error) {
        console.error("joinSession error", result.error);
        statusLine.textContent = "ê³µë¶€ ì‹œì‘ì„ í‘œì‹œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
        return;
      }
      statusLine.textContent =
        "ì§€ê¸ˆ ê³µë¶€ ì¤‘ìœ¼ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’ª (ìŠ¤í‹°ì»¤ëŠ” ì œì‹œê°„ ì‹œì‘Â·ì¢…ë£Œ ì‹œ ê¸°ë¡ë¼ìš”)";
      loadActiveMembers();
    }

    async function recordSticker(info) {
      var existingResult = await supabase
        .from("pomodoro_sessions")
        .select("id")
        .eq("member_name", selectedName)
        .eq("block_key", info.blockKey)
        .limit(1);

      if (existingResult.error) {
        console.error("recordSticker select error", existingResult.error);
        return;
      }
      var existing = existingResult.data;
      if (existing && existing.length) return;

      var insertResult = await supabase.from("pomodoro_sessions").insert({
        member_name: selectedName,
        block_key: info.blockKey,
        block_date: info.blockDateStr,
        block_start: info.blockStart.toISOString(),
        block_end: info.blockEnd.toISOString(),
        earned_sticker: true
      });

      if (insertResult.error) {
        console.error("recordSticker insert error", insertResult.error);
      }
    }

    async function leaveSession() {
      if (!selectedName) return;

      var now = new Date();
      var info = getCurrentBlock(now);
      statusLine.textContent = "ê³µë¶€ ì¢…ë£Œ í‘œì‹œ ì¤‘...";

      var activeResult = await supabase
        .from("pomodoro_active")
        .select("joined_at")
        .eq("member_name", selectedName)
        .limit(1);

      var joinAt = null;
      if (!activeResult.error && activeResult.data && activeResult.data.length) {
        joinAt = activeResult.data[0].joined_at
          ? new Date(activeResult.data[0].joined_at)
          : null;
      }

      var deleteResult = await supabase
        .from("pomodoro_active")
        .delete()
        .eq("member_name", selectedName);

      if (deleteResult.error) {
        console.error("leaveSession error", deleteResult.error);
        statusLine.textContent = "ê³µë¶€ ì¢…ë£Œë¥¼ í‘œì‹œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
        return;
      }

      var startWindowStart = new Date(
        info.blockStart.getTime() - 5 * 60 * 1000
      );
      var startWindowEnd = new Date(info.blockStart.getTime() + 5 * 60 * 1000);
      var endOk = now >= info.blockEnd && now <= info.endDeadline;
      var startOk =
        joinAt &&
        joinAt >= startWindowStart &&
        joinAt <= startWindowEnd;

      if (startOk && endOk) {
        await recordSticker(info);
        statusLine.textContent = "25ë¶„ ì„¸ì…˜ ìŠ¤í‹°ì»¤ íšë“! ğŸ…";
      } else if (!startOk && endOk) {
        statusLine.textContent =
          "ì´ë²ˆ ì„¸ì…˜ì€ ëŠ¦ê²Œ ì°¸ì—¬í•´ì„œ ìŠ¤í‹°ì»¤ëŠ” ì—†ì§€ë§Œ, ëê¹Œì§€ ê³µë¶€í•œ ê²ƒë§Œìœ¼ë¡œë„ ìµœê³ ! ğŸ‘";
      } else {
        statusLine.textContent =
          "ê³µë¶€ ì¢…ë£ŒëŠ” ë˜ì—ˆì§€ë§Œ, ìŠ¤í‹°ì»¤ ì¡°ê±´ì€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤ ğŸ˜¢ (ì œì‹œê°„ ì‹œì‘Â·ì¢…ë£Œ í•„ìš”)";
      }

      loadActiveMembers();
    }

    startBtn.addEventListener("click", joinSession);
    stopBtn.addEventListener("click", leaveSession);

    /* ---- ìŠ¤í‹°ì»¤ ê¸°ë¡ ---- */
    async function loadRecentStickers() {
      var today = new Date();
      var todayStr = getLocalDateStr(today);
      var yesterday = new Date(today.getTime());
      yesterday.setDate(yesterday.getDate() - 1);
      var yStr = getLocalDateStr(yesterday);

      statusLine.textContent = "ìŠ¤í‹°ì»¤ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      var result = await supabase
        .from("pomodoro_sessions")
        .select("*")
        .in("block_date", [yStr, todayStr])
        .order("block_date", { ascending: true })
        .order("block_start", { ascending: true })
        .order("member_name", { ascending: true });

      var data = result.data;
      var error = result.error;

      if (error) {
        console.error("loadRecentStickers error", error);
        statusLine.textContent = "ìŠ¤í‹°ì»¤ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
        return;
      }
      statusLine.textContent = "";
      renderStickerTable(data || [], { todayStr: todayStr, yStr: yStr });
    }

    function renderStickerTable(rows, opts) {
      var todayStr = opts.todayStr;
      var yStr = opts.yStr;

      stickerTableEl.innerHTML = "";

      if (!rows.length) {
        stickerTableEl.innerHTML =
          '<div class="no-stickers">ìŠ¤í‹°ì»¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      var byDate = new Map();
      rows.forEach(function (row) {
        if (!byDate.has(row.block_date)) byDate.set(row.block_date, []);
        byDate.get(row.block_date).push(row);
      });

      var dates = Array.from(byDate.keys()).sort();
      var html = "";

      dates.forEach(function (date) {
        var label;
        if (date === todayStr) {
          label = "ğŸ“… ì˜¤ëŠ˜ (" + date + ")";
        } else if (date === yStr) {
          label = "ğŸ“… ì–´ì œ (" + date + ")";
        } else {
          label = "ğŸ“… " + date;
        }

        html += '<div class="date-label">' + label + "</div>";

        var rowsForDate = byDate.get(date);
        var blocks = new Map();

        rowsForDate.forEach(function (row) {
          var key = row.block_key;
          var start = new Date(row.block_start);
          if (!blocks.has(key)) blocks.set(key, { start: start, members: [] });
          blocks.get(key).members.push(row.member_name);
        });

        var entries = Array.from(blocks.values()).sort(function (a, b) {
          return a.start - b.start;
        });

        html +=
          '<table><thead><tr><th>ì„¸ì…˜</th><th>ìŠ¤í‹°ì»¤ ë©¤ë²„</th></tr></thead><tbody>';

        entries.forEach(function (b) {
          var timeLabel = b.start.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit"
          });
          html +=
            '<tr><td class="time-col">' +
            timeLabel +
            "</td><td>" +
            b.members.join(", ") +
            "</td></tr>";
        });

        html += "</tbody></table>";
      });

      stickerTableEl.innerHTML = html;
    }

    showStickersBtn.addEventListener("click", loadRecentStickers);

    /* ---- í•  ì¼ ë³´ë“œ ---- */
    function getEmojiFromName(name) {
      var chars = Array.from(name);
      return chars[chars.length - 1] || "ğŸ…";
    }

    function buildBoardSlotsForToday() {
      var today = new Date();
      today.setHours(6, 0, 0, 0);
      var slots = [];

      for (var i = 0; i < 36; i++) {
        var start = new Date(today.getTime() + i * 30 * 60 * 1000);
        slots.push({
          start: start,
          blockKey: start.toISOString(),
          label: start.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit"
          }),
          dateStr: getLocalDateStr(start)
        });
      }
      return slots;
    }

    async function openBoard() {
      if (!selectedName) {
        alert("ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        return;
      }
      statusLine.textContent = "í•  ì¼ ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

      var today = new Date();
      var todayStr = getLocalDateStr(today);
      boardSlots = buildBoardSlotsForToday();

      var taskResult = await supabase
        .from("pomodoro_tasks")
        .select("*")
        .eq("block_date", todayStr);

      if (taskResult.error) {
        console.error("openBoard tasks error", taskResult.error);
        statusLine.textContent = "ì˜¤ëŠ˜ í•  ì¼ ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
        return;
      }

      var tasks = taskResult.data || [];
      var memberSet = new Set();
      tasks.forEach(function (row) {
        if (row.member_name) memberSet.add(row.member_name);
      });
      memberSet.add(selectedName);

      var members = Array.from(memberSet);
      members.sort(function (a, b) {
        return a.localeCompare(b, "ko-KR");
      });
      members = [selectedName].concat(
        members.filter(function (n) {
          return n !== selectedName;
        })
      );
      boardMembers = members;

      var stickerResult = await supabase
        .from("pomodoro_sessions")
        .select("*")
        .eq("block_date", todayStr)
        .eq("earned_sticker", true)
        .in("member_name", members);

      if (stickerResult.error) {
        console.error("openBoard stickers error", stickerResult.error);
      }

      var stickers = stickerResult.data || [];

      var taskMap = new Map();
      tasks.forEach(function (row) {
        if (!memberSet.has(row.member_name)) return;
        var key = row.member_name + "|" + row.block_key;
        taskMap.set(key, row);
      });

      var stickerSet = new Set();
      stickers.forEach(function (row) {
        var key = row.member_name + "|" + row.block_key;
        stickerSet.add(key);
      });

      renderTaskBoard(taskMap, stickerSet);

      nameScreen.classList.add("hidden");
      timerScreen.classList.add("hidden");
      chatScreen.classList.add("hidden");
      boardScreen.classList.remove("hidden");
      statusLine.textContent = "";
    }

    function renderTaskBoard(taskMap, stickerSet) {
      taskBoardTable.innerHTML = "";
      boardEditableInputs = [];

      var thead = document.createElement("thead");
      var headRow = document.createElement("tr");

      var memberTh = document.createElement("th");
      memberTh.textContent = "ì´ë¦„";
      memberTh.className = "member-col";
      headRow.appendChild(memberTh);

      boardSlots.forEach(function (slot) {
        var th = document.createElement("th");
        th.textContent = slot.label;
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      taskBoardTable.appendChild(thead);

      var tbody = document.createElement("tbody");

      boardMembers.forEach(function (member) {
        var tr = document.createElement("tr");

        var nameTd = document.createElement("td");
        nameTd.textContent = member;
        nameTd.className = "member-col";
        tr.appendChild(nameTd);

        var isMe = member === selectedName;
        var emoji = getEmojiFromName(member);

        boardSlots.forEach(function (slot) {
          var key = member + "|" + slot.blockKey;
          var existing = taskMap.get(key);
          var hasSticker = stickerSet.has(key);

          var td = document.createElement("td");
          td.className = "board-task-cell";
          if (isMe) td.classList.add("me");

          if (isMe) {
            var input = document.createElement("input");
            input.type = "text";
            input.className = "board-task-input";
            input.value = existing ? existing.task_text : "";
            input.dataset.blockKey = slot.blockKey;
            input.dataset.dateStr = slot.dateStr;

            boardEditableInputs.push({ input: input, existing: existing });
            td.appendChild(input);
          } else {
            var div = document.createElement("div");
            div.className = "board-task-text-readonly";
            div.textContent = existing ? existing.task_text : "";
            td.appendChild(div);
          }

          if (hasSticker) {
            var em = document.createElement("span");
            em.className = "board-task-emoji";
            em.textContent = emoji;
            td.appendChild(em);
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      taskBoardTable.appendChild(tbody);
    }

    async function saveBoard() {
      if (!selectedName || !boardEditableInputs.length) {
        boardScreen.classList.add("hidden");
        timerScreen.classList.remove("hidden");
        return;
      }

      var rowsToUpsert = [];
      var keysToDelete = [];

      boardEditableInputs.forEach(function (obj) {
        var input = obj.input;
        var existing = obj.existing;

        var text = input.value.trim();
        var blockKey = input.dataset.blockKey;
        var dateStr = input.dataset.dateStr;
        var start = new Date(blockKey);

        if (text) {
          rowsToUpsert.push({
            member_name: selectedName,
            block_key: blockKey,
            block_date: dateStr,
            block_start: start.toISOString(),
            task_text: text
          });
        } else if (existing && existing.block_key) {
          keysToDelete.push(existing.block_key);
        }
      });

      statusLine.textContent = "ë‚´ í•  ì¼ ì €ì¥ ì¤‘...";

      if (rowsToUpsert.length) {
        var upsertResult = await supabase
          .from("pomodoro_tasks")
          .upsert(rowsToUpsert, { onConflict: "member_name,block_key" });

        if (upsertResult.error) {
          console.error("saveBoard upsert error", upsertResult.error);
          statusLine.textContent = "í•  ì¼ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
          return;
        }
      }

      if (keysToDelete.length) {
        var deleteResult = await supabase
          .from("pomodoro_tasks")
          .delete()
          .eq("member_name", selectedName)
          .in("block_key", keysToDelete);

        if (deleteResult.error) {
          console.error("saveBoard delete error", deleteResult.error);
          statusLine.textContent = "ì¼ë¶€ í•  ì¼ì„ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
          return;
        }
      }

      statusLine.textContent = "ì˜¤ëŠ˜ í•  ì¼ ë³´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœï¸";
      boardScreen.classList.add("hidden");
      timerScreen.classList.remove("hidden");

      var info = getCurrentBlock();
      loadCurrentSessionTasks(info);
    }

    openBoardBtn.addEventListener("click", openBoard);
    backToTimerBtn.addEventListener("click", function () {
      boardScreen.classList.add("hidden");
      timerScreen.classList.remove("hidden");
    });
    saveBoardBtn.addEventListener("click", saveBoard);

    /* ---- ëŒ€í™”ë°© ---- */
    function renderChatMessages(rows) {
      chatMessagesCache = rows;
      chatMessagesEl.innerHTML = "";

      if (!rows.length) {
        chatMessagesEl.innerHTML =
          '<div style="font-size:0.8rem;color:#999;">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ì¸ì‚¬ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš” ğŸ˜Š</div>';
        return;
      }

      rows.forEach(function (row) {
        var wrapper = document.createElement("div");
        wrapper.className = "chat-message";
        if (row.member_name === selectedName) wrapper.classList.add("me");

        var meta = document.createElement("div");
        meta.className = "chat-meta";

        var nameSpan = document.createElement("span");
        nameSpan.textContent = row.member_name || "ìµëª…";

        var timeSpan = document.createElement("span");
        if (row.created_at) {
          var d = new Date(row.created_at);
          timeSpan.textContent = d.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit"
          });
        } else {
          timeSpan.textContent = "";
        }

        meta.appendChild(nameSpan);
        meta.appendChild(timeSpan);

        var textDiv = document.createElement("div");
        textDiv.className = "chat-text";
        textDiv.textContent = row.message;

        wrapper.appendChild(meta);
        wrapper.appendChild(textDiv);

        chatMessagesEl.appendChild(wrapper);
      });

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function loadChatMessages() {
      var result = await supabase
        .from("pomodoro_chat")
        .select("*")
        .order("created_at", { ascending: true })
        .limit(200);

      if (result.error) {
        console.error("loadChatMessages error", result.error);
        return;
      }
      renderChatMessages(result.data || []);
    }

    async function sendChat() {
      if (!selectedName) {
        alert("ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        return;
      }
      var text = chatInputEl.value.trim();
      if (!text) return;

      chatInputEl.value = "";

      var localRow = {
        id: Date.now(),
        member_name: selectedName,
        message: text,
        created_at: new Date().toISOString()
      };
      chatMessagesCache.push(localRow);
      renderChatMessages(chatMessagesCache);

      var result = await supabase
        .from("pomodoro_chat")
        .insert({ member_name: selectedName, message: text });

      if (result.error) {
        console.error("sendChat error", result.error);
        statusLine.textContent = "ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢";
      }
    }

    function showChatScreen() {
      if (!selectedName) {
        alert("ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
        return;
      }
      nameScreen.classList.add("hidden");
      timerScreen.classList.add("hidden");
      boardScreen.classList.add("hidden");
      chatScreen.classList.remove("hidden");
      statusLine.textContent = "";
      loadChatMessages();

      setTimeout(function () {
        chatInputEl.focus();
      }, 50);
    }

    openChatBtn.addEventListener("click", showChatScreen);
    backFromChatBtn.addEventListener("click", showTimerScreen);
    sendChatBtn.addEventListener("click", sendChat);

    chatInputEl.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });

    /* ---- ì‹¤ì‹œê°„ ì±„ë„ ---- */
    supabase
      .channel("pomodoro_active_channel")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "pomodoro_active" },
        function () {
          loadActiveMembers();
        }
      )
      .subscribe();

    supabase
      .channel("pomodoro_chat_channel")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "pomodoro_chat" },
        function () {
          loadChatMessages();
        }
      )
      .subscribe();

    /* ---- ì´ˆê¸°í™” ---- */
    function init() {
      var savedName = localStorage.getItem("pomodoroName");
      if (savedName && MEMBERS.indexOf(savedName) !== -1) {
        selectedName = savedName;
      }
      renderNameButtons("");

      if (selectedName) showTimerScreen();
      else showNameScreen();
    }

    init();
  </script>
</body>
</html>
